<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Computer Usage - CLMS</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .usage-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            width: 100%;
        }
        .usage-header {
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            color: white;
            padding: 30px 20px;
            text-align: center;
            border-radius: 15px 15px 0 0;
        }
        .usage-body {
            padding: 30px;
        }
        .computer-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #4361ee;
        }
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        .info-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .info-label {
            font-weight: 600;
            color: #495057;
        }
        .info-value {
            color: #212529;
            font-weight: 500;
        }
        .btn-submit {
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            border: none;
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
        }
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .token-status {
            font-size: 0.9rem;
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
        }
        .token-valid {
            background: #d1edff;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .token-invalid {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="usage-container">
            <div class="usage-header">
                <h3><i class="fas fa-laptop me-2"></i>Computer Laboratory Management System</h3>
                <p class="mb-0 mt-2 opacity-75">Student Computer Usage</p>
            </div>
            
            <div class="usage-body">
                <!-- Computer Information Display -->
                <div class="computer-info" id="computerInfo">
                    <div class="info-item">
                        <span class="info-label">Laboratory:</span>
                        <span class="info-value" id="labName">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Computer:</span>
                        <span class="info-value" id="pcNumber">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Status:</span>
                        <span class="info-value" id="computerStatus">-</span>
                    </div>
                </div>

                <!-- Token Status -->
                <div class="token-status token-valid" id="tokenStatus" style="display: none;">
                    <i class="fas fa-shield-alt me-2"></i>
                    <span id="tokenMessage">Token is valid</span>
                </div>

                <!-- Student Usage Form -->
                <form id="usageForm">
                    <div class="mb-3">
                        <label for="studentId" class="form-label">Student ID</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                            <input type="text" class="form-control" id="studentId" 
                                   placeholder="Enter your student ID" required
                                   pattern="[A-Za-z0-9]+"
                                   title="Please enter a valid student ID">
                        </div>
                        <div class="form-text">Enter your registered student ID</div>
                    </div>

                    <button type="submit" class="btn btn-submit" id="submitBtn">
                        <i class="fas fa-play-circle me-2"></i>Start Computer Usage
                    </button>
                </form>

                <!-- Usage History -->
                <div class="mt-4" id="usageHistory" style="display: none;">
                    <h6 class="border-bottom pb-2">Recent Usage</h6>
                    <div id="historyList" class="small">
                        <!-- Usage history will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const labName = urlParams.get('lab');
        const pcNumber = urlParams.get('pc');
        const token = urlParams.get('token');
        const computerId = urlParams.get('computerId');

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('URL Parameters:', { labName, pcNumber, token, computerId });
            initializePage();
            debugTokens();
        });

        // Initialize page with URL parameters
        function initializePage() {
            if (!labName || !pcNumber || !token || !computerId) {
                showError('Invalid QR Code. Missing required parameters. Please scan a valid computer QR code.');
                return;
            }

            // Validate token first
            const tokenValidation = validateToken(computerId, token);
            
            if (!tokenValidation.isValid) {
                showError(`Token validation failed: ${tokenValidation.message}`);
                return;
            }

            // Load computer data
            const computers = JSON.parse(localStorage.getItem('computers')) || [];
            const computer = computers.find(c => c.id === parseInt(computerId));
            
            if (!computer) {
                showError('Computer not found in system.');
                return;
            }

            // Display computer information
            document.getElementById('labName').textContent = labName;
            document.getElementById('pcNumber').textContent = pcNumber;
            document.getElementById('computerStatus').textContent = computer.status;
            
            // Update status color based on computer status
            const statusElement = document.getElementById('computerStatus');
            if (computer.status === 'Working') {
                statusElement.className = 'info-value text-success fw-bold';
            } else if (computer.status === 'Under Maintenance') {
                statusElement.className = 'info-value text-warning fw-bold';
            } else {
                statusElement.className = 'info-value text-danger fw-bold';
            }

            // Show token status
            document.getElementById('tokenStatus').style.display = 'block';
            document.getElementById('tokenMessage').textContent = tokenValidation.message;
            
            // Load usage history for this computer
            loadUsageHistory(computerId);
        }

        // Enhanced token validation
        function validateToken(computerId, providedToken) {
            try {
                const tokens = JSON.parse(localStorage.getItem('computerTokens')) || {};
                const computerToken = tokens[computerId];
                
                console.log('Available tokens:', tokens);
                console.log('Looking for computerId:', computerId);
                console.log('Found token:', computerToken);
                
                if (!computerToken) {
                    return { isValid: false, message: 'No token found for this computer' };
                }

                const currentTime = Date.now();
                console.log('Current time:', new Date(currentTime).toLocaleString());
                console.log('Token expiry:', new Date(computerToken.expiry).toLocaleString());
                console.log('Token matches:', computerToken.token === providedToken);
                console.log('Token not expired:', computerToken.expiry > currentTime);
                
                // Check if token matches and is not expired
                if (computerToken.token === providedToken) {
                    if (computerToken.expiry > currentTime) {
                        const timeRemaining = Math.ceil((computerToken.expiry - currentTime) / (60 * 1000));
                        return { 
                            isValid: true, 
                            message: `Token valid (expires in ${timeRemaining} minutes)` 
                        };
                    } else {
                        return { 
                            isValid: false, 
                            message: 'Token has expired' 
                        };
                    }
                } else {
                    return { 
                        isValid: false, 
                        message: 'Token mismatch' 
                    };
                }
            } catch (error) {
                console.error('Token validation error:', error);
                return { 
                    isValid: false, 
                    message: 'Error validating token' 
                };
            }
        }

        // Load usage history for this computer
        function loadUsageHistory(computerId) {
            const usageHistory = JSON.parse(localStorage.getItem('usageHistory')) || [];
            const computerUsage = usageHistory.filter(usage => usage.computerId === parseInt(computerId))
                                             .slice(-5) // Last 5 entries
                                             .reverse();
            
            if (computerUsage.length > 0) {
                document.getElementById('usageHistory').style.display = 'block';
                const historyList = document.getElementById('historyList');
                historyList.innerHTML = '';
                
                computerUsage.forEach(usage => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'd-flex justify-content-between border-bottom py-2';
                    historyItem.innerHTML = `
                        <span>${usage.studentId}</span>
                        <small class="text-muted">${new Date(usage.startTime).toLocaleString()}</small>
                    `;
                    historyList.appendChild(historyItem);
                });
            }
        }

        // Submit usage form
        document.getElementById('usageForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const studentId = document.getElementById('studentId').value.trim();
            
            if (!studentId) {
                showError('Please enter your student ID.');
                return;
            }

            // Revalidate token before proceeding
            const tokenValidation = validateToken(computerId, token);
            if (!tokenValidation.isValid) {
                showError(`Session expired: ${tokenValidation.message}. Please scan the QR code again.`);
                return;
            }

            // Validate student exists
            const students = JSON.parse(localStorage.getItem('students')) || [];
            const student = students.find(s => s.studentId.toLowerCase() === studentId.toLowerCase());
            
            if (!student) {
                showError('Student ID not found. Please check your ID or contact administrator.');
                return;
            }

            // Check if computer is available
            const computers = JSON.parse(localStorage.getItem('computers')) || [];
            const computer = computers.find(c => c.id === parseInt(computerId));
            
            if (computer.status !== 'Working') {
                showError(`This computer is currently ${computer.status.toLowerCase()}. Please use another computer.`);
                return;
            }

            // Record usage
            recordComputerUsage(studentId, computerId);
        });

        // Record computer usage
        function recordComputerUsage(studentId, computerId) {
            const usageHistory = JSON.parse(localStorage.getItem('usageHistory')) || [];
            
            const usageRecord = {
                id: Date.now(),
                studentId: studentId,
                computerId: parseInt(computerId),
                laboratoryName: labName,
                pcNumber: pcNumber,
                startTime: new Date().toISOString(),
                status: 'active'
            };
            
            usageHistory.push(usageRecord);
            localStorage.setItem('usageHistory', JSON.stringify(usageHistory));
            
            // Show success message
            Swal.fire({
                icon: 'success',
                title: 'Usage Started!',
                html: `
                    <div class="text-start">
                        <p><strong>Student:</strong> ${studentId}</p>
                        <p><strong>Computer:</strong> ${labName} - ${pcNumber}</p>
                        <p><strong>Time:</strong> ${new Date().toLocaleString()}</p>
                    </div>
                `,
                confirmButtonColor: '#3085d6',
                confirmButtonText: 'OK'
            }).then(() => {
                // Reset form
                document.getElementById('usageForm').reset();
                // Reload history
                loadUsageHistory(computerId);
            });
        }

        // Show error message
        function showError(message) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: message,
                confirmButtonColor: '#3085d6',
                confirmButtonText: 'OK'
            });
        }

        // Debug function to check tokens
        function debugTokens() {
            const tokens = JSON.parse(localStorage.getItem('computerTokens')) || {};
            console.log('All tokens in storage:', tokens);
        }

        // Auto-refresh tokens every 30 seconds
        setInterval(() => {
            if (computerId && token) {
                if (!validateToken(computerId, token)) {
                    showError('Session expired. Please scan the QR code again.');
                }
            }
        }, 30000);
    </script>
</body>
</html>